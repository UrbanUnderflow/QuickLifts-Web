rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isAdmin() {
      return isAuthenticated() && 
             request.auth.token.get('admin', false) == true;
    }
    

    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function isCoachOwner(coachId) {
      return isAuthenticated() && request.auth.uid == coachId;
    }
    
    // Users collection rules
    match /users/{userId} {
      // Allow read/write for the user themselves or admin
      allow read, write: if isOwner(userId) || isAdmin();
      
      // Allow coaches to read their linked athletes
      allow read: if isAuthenticated() && 
                     resource.data.linkedCoachId == request.auth.uid;
    }
    
    // Coaches collection rules
    match /coaches/{coachId} {
      // Only the coach themselves can read/write their coach document
      allow read, write: if isCoachOwner(coachId) || isAdmin();
      
      // Allow creation only if the userId matches the authenticated user
      allow create: if isAuthenticated() && 
                       request.resource.data.userId == request.auth.uid;
    }
    
    // Coach-Athlete relationships
    match /coachAthletes/{relationshipId} {
      // Coach can read/write relationships where they are the coach
      allow read, write: if isAuthenticated() && 
                            resource.data.coachId == request.auth.uid;
      
      // Athletes can read their own relationships
      allow read: if isAuthenticated() && 
                     resource.data.athleteUserId == request.auth.uid;
      
      // Allow creation if user is the coach
      allow create: if isAuthenticated() && 
                       request.resource.data.coachId == request.auth.uid;
      
      // Admin can do everything
      allow read, write: if isAdmin();
    }
    
    // Coach referrals
    match /coachReferrals/{referralId} {
      // Referring coach can read their referrals
      allow read: if isAuthenticated() && 
                     resource.data.referrerCoachId == request.auth.uid;
      
      // Referred coach can read referrals where they are the referred coach
      allow read: if isAuthenticated() && 
                     resource.data.referredCoachId == request.auth.uid;
      
      // Only referring coach can create referrals
      allow create: if isAuthenticated() && 
                       request.resource.data.referrerCoachId == request.auth.uid;
      
      // Admin can do everything
      allow read, write: if isAdmin();
    }

    // =========================================================================
    // PulseCheck Escalation System (Admin + limited coach/athlete visibility)
    // =========================================================================

    // Admin-managed escalation conditions used for AI classification fine-tuning
    match /escalation-conditions/{conditionId} {
      // Only admins can manage/read conditions
      allow read, write: if isAdmin();
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    // Escalation records (audit log). Created/updated by backend using Admin SDK.
    // Client-side access is limited:
    // - Admins: full access
    // - Athlete: read their own records
    // - Coach: read records where they are the coach
    match /escalation-records/{recordId} {
      allow read: if isAdmin()
                  || (isAuthenticated() && resource.data.userId == request.auth.uid)
                  || (isAuthenticated() && resource.data.coachId == request.auth.uid);
      // Keep writes admin-only from client. Backend uses Admin SDK.
      allow write: if isAdmin();
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }
    
    // Existing collections - preserve current functionality
    // Note: Add your existing rules here for other collections
    
    // Example structure for other collections (customize as needed):
    
    // Daily health summaries
    match /daily-health-summaries/{summaryId} {
      allow read, write: if isOwner(resource.data.userId) || isAdmin();
      allow create: if isAuthenticated() && 
                       request.resource.data.userId == request.auth.uid;
    }
    
    // Conversations (PulseCheck)
    match /conversations/{conversationId} {
      allow read, write: if isOwner(resource.data.userId) || isAdmin();
      allow create: if isAuthenticated() && 
                       request.resource.data.userId == request.auth.uid;
    }
    
    // Programming conversations
    match /programming-conversations/{conversationId} {
      allow read, write: if isOwner(resource.data.userId) || isAdmin();
      allow create: if isAuthenticated() && 
                       request.resource.data.userId == request.auth.uid;
    }
    
    // Exercise videos
    match /exerciseVideos/{videoId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && 
                      (isOwner(resource.data.get('userId', '')) || isAdmin());
    }
    
    // Manual entries
    match /manualEntries/{entryId} {
      allow read, write: if isOwner(resource.data.userId) || isAdmin();
      allow create: if isAuthenticated() && 
                       request.resource.data.userId == request.auth.uid;
    }
    
    // Workout summaries
    match /workout-summaries/{summaryId} {
      allow read, write: if isOwner(resource.data.userId) || isAdmin();
      allow create: if isAuthenticated() && 
                       request.resource.data.userId == request.auth.uid;
    }
    
    // Daily progress
    match /daily-progress/{progressId} {
      allow read, write: if isOwner(resource.data.userId) || isAdmin();
      allow create: if isAuthenticated() && 
                       request.resource.data.userId == request.auth.uid;
    }
    
    // Plans
    match /plans/{planId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // Macro recommendations
    match /macro-recommendations/{macroId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // Meal plans
    match /meal-plan/{mealPlanId} {
      allow read, write: if isOwner(resource.data.userId) || isAdmin();
      allow create: if isAuthenticated() && 
                       request.resource.data.userId == request.auth.uid;
    }
    
    // Notes
    match /notes/{noteId} {
      allow read, write: if isOwner(resource.data.get('userId', '')) || isAdmin();
    }
    
    // Timezone history
    match /timezone-history/{historyId} {
      allow read, write: if isOwner(resource.data.userId) || isAdmin();
      allow create: if isAuthenticated() && 
                       request.resource.data.userId == request.auth.uid;
    }
    
    // Prize records
    match /prizeRecords/{recordId} {
      allow read, write: if isOwner(resource.data.userId) || isAdmin();
    }
    
    // Challenge prizes
    match /challenge-prizes/{prizeId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // Payments
    match /payments/{paymentId} {
      allow read, write: if isOwner(resource.data.ownerId) || isAdmin();
    }
    
    // Chats
    match /chats/{chatId} {
      allow read, write: if isAuthenticated() && 
                            request.auth.uid in resource.data.participantIds;
      allow create: if isAuthenticated() && 
                       request.auth.uid in request.resource.data.participantIds;
    }
    
    // Messages within chats
    match /chats/{chatId}/messages/{messageId} {
      allow read: if isAuthenticated() && 
                     request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participantIds;
      allow create: if isAuthenticated() && 
                       request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participantIds &&
                       request.resource.data.senderId == request.auth.uid;
    }
    
    // Sweatlist collections
    match /sweatlist-collections/{collectionId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && 
                      (request.auth.uid in resource.data.ownerId || isAdmin());
    }
    
    // Checkins
    match /checkins/{checkinId} {
      allow read, write: if isOwner(resource.data.get('userId', '')) || isAdmin();
    }
    
    // Encouragement
    match /encouragement/{encouragementId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && 
                       request.resource.data.fromUser.id == request.auth.uid;
    }
    
    // Logs
    match /logs/{logId} {
      allow read, write: if isOwner(resource.data.userId) || isAdmin();
      allow create: if isAuthenticated() && 
                       request.resource.data.userId == request.auth.uid;
    }
    
    // Workouts
    match /workouts/{workoutId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && 
                      (isOwner(resource.data.fromUser.id) || isAdmin());
    }
    
    // Daily reflections
    match /daily-reflections/{reflectionId} {
      allow read, write: if isOwner(resource.data.get('userId', '')) || isAdmin();
    }
    
    // Promo codes collection rules
    match /promoCodes/{promoCodeId} {
      allow read: if isAdmin(); // Only admins can read promo codes directly
      allow write: if isAdmin(); // Only admins can create/update promo codes
    }

    // Promo code usage tracking
    match /promoCodeUsage/{usageId} {
      allow read: if resource.data.userId == request.auth.uid || isAdmin();
      allow write: if false; // Only backend can track usage
    }
    
    // Secure access logs - admin only (sensitive security data)
    match /secureAccessLogs/{logId} {
      allow read: if isAdmin(); // Only admins can read security logs
      allow write: if false; // Only server-side functions can write logs
    }
    
    // Legal documents - admin only
    match /legal-documents/{documentId} {
      allow read, write: if isAdmin();
    }
    
    // Document notes - for shared legal doc annotations
    match /document-notes/{noteId} {
      allow read, write: if true; // Public access for shared documents
    }
    
    // Equity documents - admin only
    match /equity-documents/{documentId} {
      allow read, write: if isAdmin();
    }
    
    // Equity stakeholders - admin only
    match /equity-stakeholders/{stakeholderId} {
      allow read, write: if isAdmin();
    }
    
    // Equity pool - admin only
    match /equity-pool/{poolId} {
      allow read, write: if isAdmin();
    }
    
    // Signing requests - admin only
    match /signing-requests/{requestId} {
      allow read, write: if isAdmin();
      // Allow public read for signing pages (they'll use the request ID as auth)
      allow read: if true;
    }
    
    // Creator Pages (Landing Pages)
    match /creator-pages/{userId} {
      // Allow owner to read/write their creator pages root
      allow read, write: if isOwner(userId) || isAdmin();
      
      // Pages subcollection
      match /pages/{pageSlug} {
        // Anyone can read published pages
        allow read: if true;
        // Only owner can write
        allow write: if isOwner(userId) || isAdmin();
        
        // Surveys subcollection
        match /surveys/{surveyId} {
          // Anyone can read surveys (to take them)
          allow read: if true;
          // Only owner can create/edit/delete surveys
          allow write: if isOwner(userId) || isAdmin();
          
          // Survey responses subcollection
          match /responses/{responseId} {
            // Owner can read responses
            allow read: if isOwner(userId) || isAdmin();
            // Anyone can submit a response
            allow create: if true;
            // Only owner can update/delete responses
            allow update, delete: if isOwner(userId) || isAdmin();
          }
        }
        
        // Check-ins subcollection
        match /check-ins/{checkInId} {
          // Only owner can read/write check-ins
          allow read, write: if isOwner(userId) || isAdmin();
        }
      }
      
      // Waitlist subcollection
      match /waitlist/{entryId} {
        // Owner can read/write waitlist entries
        allow read, write: if isOwner(userId) || isAdmin();
        // Anyone can create waitlist entries (signing up)
        allow create: if true;
      }
    }
    
    // ============================================================================
    // MENTAL TRAINING COLLECTIONS
    // ============================================================================
    
    // Mental Exercise Library (admin-managed templates)
    match /mental-exercises/{exerciseId} {
      // Anyone authenticated can read exercises
      allow read: if isAuthenticated();
      // Only admins can write (seed/update/delete)
      allow write: if isAdmin();
    }
    
    // Mental Exercise Assignments
    match /mental-exercise-assignments/{assignmentId} {
      // Athletes can read their own assignments, coaches can read assignments they created
      allow read: if isAuthenticated() && 
        (resource.data.athleteUserId == request.auth.uid || 
         resource.data.assignedBy == request.auth.uid);
      // Coaches can create assignments for their athletes
      allow create: if isAuthenticated();
      // Athletes can update their assignment status, coaches can update assignments they created
      allow update: if isAuthenticated() && 
        (resource.data.athleteUserId == request.auth.uid || 
         resource.data.assignedBy == request.auth.uid);
      allow delete: if isAdmin();
    }
    
    // Mental Exercise Completions (user-specific subcollection)
    match /mental-exercise-completions/{userId}/completions/{completionId} {
      allow read, write: if isOwner(userId) || isAdmin();
    }
    
    // Mental Training Streaks
    match /mental-training-streaks/{userId} {
      allow read, write: if isOwner(userId) || isAdmin();
    }
    
    // Mental Check-ins
    match /mental-check-ins/{userId}/check-ins/{checkInId} {
      allow read, write: if isOwner(userId) || isAdmin();
    }
    
    // Mental Training Programs (admin-managed)
    match /mental-training-programs/{programId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    // App Config (admin-managed global settings)
    match /app-config/{docId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // User Program Enrollments
    match /mental-program-enrollments/{userId}/enrollments/{enrollmentId} {
      allow read, write: if isOwner(userId) || isAdmin();
    }
    
    // Admin collection (used by AdminRouteGuard to check admin status)
    match /admin/{email} {
      // Any authenticated user can read to check if they are admin
      allow read: if isAuthenticated();
      // Only existing admins can modify admin list (but this uses custom claim which may not be set)
      allow write: if false; // Managed via Firebase Console or Admin SDK only
    }

    // ============================================================================
    // AGENT SYSTEM COLLECTIONS
    // ============================================================================
    
    // Agent commands (chat messages & task assignments)
    // UI access is already gated by AdminRouteGuard (doc-based admin check)
    // Agent runner uses Admin SDK which bypasses rules entirely
    match /agent-commands/{commandId} {
      allow read, write: if isAuthenticated();
    }
    
    // Agent presence (online status, current task, etc.)
    match /agent-presence/{agentId} {
      // Any authenticated user can read agent presence (for Virtual Office)
      allow read: if isAuthenticated();
      // Only admins can write (agent runner uses Admin SDK, so this is for web UI)
      allow write: if isAdmin();
      
      // Task history subcollection
      match /task-history/{historyId} {
        allow read: if isAuthenticated();
        allow write: if isAdmin();
      }
    }
    
    // Kanban tasks (agent task board)
    match /kanban-tasks/{taskId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    // Default deny rule for any unmatched documents
    match /{document=**} {
      allow read, write: if false;
    }
  }
}

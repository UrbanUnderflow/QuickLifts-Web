# Netlify configuration for Pulse Web App
[dev]
  command = "next dev"
  framework = "next"
  port = 8888
  targetPort = 3000
  functionsPort = 9999

[build]
  command = "next build"
  publish = ".next"
  functions = "netlify/functions"

# Environment variables should be set in Netlify UI, not in the toml file
[context.production]
[context.branch-deploy]
[context.deploy-preview]

[[plugins]]
  package = "@netlify/plugin-nextjs"

# Branded OG images (route through a normal URL so bot user agents aren't blocked by /.netlify/functions)
# Keeps query params (title/subtitle) intact.
[[redirects]]
  from = "/og-image.png"
  to = "/.netlify/functions/og-image"
  status = 200
  force = true

[[redirects]]
  from = "/og-image"
  to = "/.netlify/functions/og-image"
  status = 200
  force = true


# NOTE: Do NOT add SPA-style catch-all redirects like "/* → / 200" here.
# The @netlify/plugin-nextjs plugin handles ALL Next.js routing automatically.
# Adding manual redirects will BREAK direct navigation / hard refreshes.
# See docs/netlify-routing-fix.md for details.

[[headers]]
  for = "/*"
  [headers.values]
    Cache-Control = "public, max-age=0, must-revalidate"
    X-Frame-Options = "DENY"
    X-Content-Type-Options = "nosniff"
    Referrer-Policy = "strict-origin-when-cross-origin"
    # Enable compression negotiation
    Vary = "Accept-Encoding"

# Specific headers for static assets with compression
[[headers]]
  for = "/static/*"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"
    Vary = "Accept-Encoding"

# Headers for JavaScript bundles
[[headers]]
  for = "/*.js"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"
    Vary = "Accept-Encoding"
    Content-Type = "application/javascript; charset=utf-8"

# Headers for CSS files
[[headers]]
  for = "/*.css"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"
    Vary = "Accept-Encoding"
    Content-Type = "text/css; charset=utf-8"

# Headers for JSON files
[[headers]]
  for = "/*.json"
  [headers.values]
    Vary = "Accept-Encoding"
    Content-Type = "application/json; charset=utf-8"

# Headers for HTML files
[[headers]]
  for = "/*.html"
  [headers.values]
    Cache-Control = "public, max-age=0, must-revalidate"
    Vary = "Accept-Encoding"
    Content-Type = "text/html; charset=utf-8"

# Headers for SVG files
[[headers]]
  for = "/*.svg"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"
    Vary = "Accept-Encoding"
    Content-Type = "image/svg+xml"

# Headers for font files (WOFF2 is already compressed)
[[headers]]
  for = "/*.woff2"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
  for = "/*.woff"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"
    Vary = "Accept-Encoding"

# Headers for _next directory (Next.js build output)
[[headers]]
  for = "/_next/static/*"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"
    Vary = "Accept-Encoding"

# Headers for API routes
[[headers]]
  for = "/api/*"
  [headers.values]
    Cache-Control = "no-cache, no-store, must-revalidate"
    Vary = "Accept-Encoding"

[functions]
  directory = "netlify/functions"
  included_files = ["netlify/functions/**"]
  external_node_modules = ["stripe"]
  node_bundler = "esbuild"

# Schedule the update-challenge-status function to run daily
[functions.update-challenge-status]
  schedule = "@daily"

# Configure the specific function as background
[functions.manual-sync-sessions]
  is_background = true

# Schedule the KPI snapshot function to run daily (before press release)
[functions.generateKpiSnapshot]
  schedule = "@daily"

# Schedule the press release draft function to run weekly
[functions.draftPress]
  schedule = "@weekly"

# Mark trigger functions as background functions without schedules
[functions.triggerDraftPress]
  is_background = true

[functions.triggerGenerateKpiSnapshot]
  is_background = true

# Schedule the Move of the Day function to run daily
[functions.scheduleMoveOfTheDay]
  schedule = "@daily"

# Schedule the calorie algorithm analysis function to run daily
[functions.analyzeCalorieAlgorithm]
  schedule = "@daily"

# Mark trigger functions as background functions without schedules
[functions.triggerCalorieAnalysis]
  is_background = true

# Lead massaging function - increased timeout for large datasets
[functions.massage-lead-column]
  timeout = 26

# Lead massaging background job (async processing)
# Start endpoint (fast): creates job + triggers worker
[functions.massage-lead-column-job]
  timeout = 26

# Worker (slow): does the actual processing in background
[functions.process-massage-lead-job]
  is_background = true
  timeout = 900

[functions.get-massage-lead-job]
  timeout = 26

[functions.cancel-massage-lead-job]
  timeout = 26

# Coach Partnership Functions
[functions.create-coach-checkout-session]
  external_node_modules = ["stripe"]

[functions.create-athlete-checkout-session]
  external_node_modules = ["stripe"]

[functions.create-partner-profile]
  # Partner profile creation (no Stripe needed)

[functions.stripe-coach-webhook]
  external_node_modules = ["stripe"]

[functions.manage-subscription]
  external_node_modules = ["stripe"]

[functions.calculate-coach-revenue]
  external_node_modules = ["stripe"]
  # Run revenue calculation daily at 6 AM UTC
  schedule = "0 6 * * *"

[functions.validate-promo-code]
  external_node_modules = ["stripe"]

[functions.get-coach-profile]
  external_node_modules = ["firebase-admin"]

[functions.analyze-sentiment]
  # Unified sentiment analysis for web and iOS
  timeout = 30

# Legal document generation (OpenAI can take 15–30s for long documents)
[functions.generate-legal-document]
  timeout = 26

[functions.revise-legal-document]
  timeout = 26

# Review Automation Functions
[functions.send-weekly-review-checkin]
  # Send weekly check-in email every Friday at 9am EST (14:00 UTC)
  schedule = "0 14 * * 5"

[functions.send-review-draft-reminder]
  # Check every Saturday at 9am EST if it's time to send draft reminder
  schedule = "0 14 * * 6"

# Schedule: username reminder email for users who started signup but never selected a username
[functions.schedule-username-reminder-email]
  # Runs on a lightweight cadence and checks Firestore for the admin-configured daily send time.
  # The function itself enforces "only once per day" at the chosen time.
  schedule = "*/30 * * * *"

# Lifecycle email schedulers
[functions.schedule-joined-round-no-workout-email]
  # Runs every 30 minutes and finds users who joined a round but still have no completed workout after ~24h.
  schedule = "*/30 * * * *"

[functions.schedule-first-workout-celebration-email]
  # Runs every 30 minutes and sends first-workout celebration after first completion event is detected.
  schedule = "*/30 * * * *"

[functions.schedule-streak-milestone-email]
  # Runs every 30 minutes and sends 3/7/14/30-day streak milestone emails.
  schedule = "*/30 * * * *"

[functions.schedule-challenge-ending-soon-email]
  # Runs every 30 minutes and sends challenge-ending reminders at ~72h and ~24h remaining.
  schedule = "*/30 * * * *"

[functions.schedule-inactivity-winback-email]
  # Runs every 30 minutes and sends inactivity winback emails at ~3/7/14 days.
  schedule = "*/30 * * * *"

[functions.trigger-review-checkin]
  # Manual trigger for weekly check-in email (no schedule)

# Mental Training: Daily check-in notifications
[functions.scheduled-mental-checkin]
  # Runs every 30 minutes and checks Firestore config for the admin-configured send times.
  # The function itself enforces "only once per day" at the chosen morning and evening times.
  schedule = "*/30 * * * *"

# Mental Training: Assignment reminders (noon local deadline)
[functions.scheduled-mental-assignment-reminder]
  # Runs every 30 minutes and sends a reminder if the user has active assignments and hasn't completed by their local reminder time (default noon).
  schedule = "*/30 * * * *"

# User Onboarding Functions
[functions.create-onboarding-link]
  # Creates a new user account and generates a one-time onboarding link
  external_node_modules = ["firebase-admin"]

[functions.complete-onboarding-password]
  # Validates token and sets the user's password
  external_node_modules = ["firebase-admin"]

[functions.send-onboarding-email]
  # Sends the branded onboarding email with set-password link

